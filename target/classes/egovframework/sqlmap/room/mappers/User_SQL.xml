<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.room.service.impl.UserMapper">

    <resultMap id="user" type="userVO">
        <result property="userIdx" column="user_idx"/>
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="departmentIdx" column="department_idx"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="passwd" column="passwd"/>
        <result property="departmentName" column="department_name"/>
    </resultMap>

    <!-- 사용자 등록 -->
    <insert id="insertUser" parameterType="userVO" useGeneratedKeys="true" keyProperty="userIdx">
        INSERT INTO users (
            id,
            name,
            department_idx,
            phone,
            email,
            passwd
        ) VALUES (
            #{id},
            #{name},
            #{departmentIdx},
            #{phone},
            #{email},
            #{passwd}
        )
    </insert>

    <!-- 사용자 수정 -->
    <update id="updateUser" parameterType="userVO">
        UPDATE users SET
            id = #{id},
            name = #{name},
            department_idx = #{departmentIdx},
            phone = #{phone},
            email = #{email}
            <if test="passwd != null and passwd != ''">
                , passwd = #{passwd}
            </if>
        WHERE user_idx = #{userIdx}
    </update>

    <!-- 사용자 삭제 -->
    <delete id="deleteUser" parameterType="userVO">
        DELETE FROM users 
        WHERE user_idx = #{userIdx}
    </delete>

    <!-- 사용자 상세 조회 -->
    <select id="selectUser" parameterType="userVO" resultMap="user">
        SELECT 
            u.user_idx,
            u.id,
            u.name,
            u.department_idx,
            u.phone,
            u.email,
            u.passwd,
            d.name as department_name
        FROM users u
        LEFT JOIN department d ON u.department_idx = d.department_idx
        WHERE u.user_idx = #{userIdx}
    </select>

    <!-- 사용자 목록 조회 -->
    <select id="selectUserList" parameterType="userVO" resultMap="user">
        SELECT 
            u.user_idx,
            u.id,
            u.name,
            u.department_idx,
            u.phone,
            u.email,
            d.name as department_name
        FROM users u
        LEFT JOIN department d ON u.department_idx = d.department_idx
        ORDER BY u.user_idx DESC
    </select>

    <!-- 사용자 총 개수 조회 -->
    <select id="selectUserListTotCnt" parameterType="userVO" resultType="int">
        SELECT COUNT(*) totcnt
        FROM users u
        LEFT JOIN department d ON u.department_idx = d.department_idx
    </select>

</mapper>